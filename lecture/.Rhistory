),
# Teaching Status
`Teaching Status` = case_when(
`Teaching Status` == "academic" ~ "Academic",
`Teaching Status` == "community" ~ "Community",
`Teaching Status` == "nonteaching" ~ "Non-Teaching",
TRUE ~ `Teaching Status`
),
# Primary Payment Method
`Primary Payment Method` = case_when(
`Primary Payment Method` == "1" ~ "Medicaid",
`Primary Payment Method` == "2" ~ "Not Billed",
`Primary Payment Method` == "3" ~ "Self-Pay",
`Primary Payment Method` == "4" ~ "Private/Commercial",
`Primary Payment Method` == "6" ~ "Medicare",
`Primary Payment Method` == "7" ~ "Other Government",
`Primary Payment Method` == "10" ~ "Other",
TRUE ~ `Primary Payment Method`
),
# Transportation
Transportation = case_when(
Transportation == "UK" ~ "Unknown",
Transportation == "Private/Public Vehicle Walk<e2><80><91>In" ~ "Private/Public Walk In",
TRUE ~ Transportation
),
# Injury Location
`Injury Location` = case_when(
`Injury Location` == "ankle" ~ "Ankle",
`Injury Location` == "clavicle" ~ "Clavicle",
`Injury Location` == "femur" ~ "Femur",
`Injury Location` == "foot" ~ "Foot",
`Injury Location` == "forearm" ~ "Forearm",
`Injury Location` == "hand" ~ "Hand",
`Injury Location` == "humerus" ~ "Humerus",
`Injury Location` == "lowerleg" ~ "Lower Leg",
`Injury Location` == "pelvis" ~ "Pelvis",
`Injury Location` == "ribs" ~ "Ribs",
`Injury Location` == "scapula" ~ "Scapula",
`Injury Location` == "skull" ~ "Skull",
`Injury Location` == "spine" ~ "Spine",
`Injury Location` == "wrist" ~ "Wrist",
TRUE ~ `Injury Location`
)
)
cat("âœ“ Variable names and levels recoded\n\n")
###############################################################
#                    PREPARE FOR ANALYSIS
###############################################################
# Ensure source_year is properly formatted
data$source_year <- as.factor(data$source_year)
# Update candidate_vars with new names
candidate_vars <- c("Age", "Sex", "Race", "Primary Payment Method",
"Work Related", "Condition Category", "Transportation",
"Injury Location", "Amputation", "ISS Category",
"Verification Level", "Bed Size", "Hospital Type", "Teaching Status")
# Create clean dataset
data_clean <- data[complete.cases(data[, c("antibiotic_binary", "source_year", candidate_vars)]), ]
# Set up output directories
tables_dir <- "/Volumes/rc/lab/R/REDS/kosarek/miller/tables/stratified_analysis/"
figures_dir <- "/Volumes/rc/lab/R/REDS/kosarek/miller/figures/stratified_analysis/"
# Create directories if they don't exist
dir.create(tables_dir, showWarnings = FALSE, recursive = TRUE)
dir.create(figures_dir, showWarnings = FALSE, recursive = TRUE)
###############################################################
#  STRATIFIED ANALYSIS: SEPARATE MODEL FOR EACH GROUP
###############################################################
cat("\n")
cat("=================================================================\n")
cat("           STRATIFIED ANALYSIS BY DEMOGRAPHIC GROUP\n")
cat("=================================================================\n\n")
# Store results for each variable
stratified_results_list <- list()
# For each demographic variable
for (var in candidate_vars) {
cat(sprintf("\nAnalyzing %s:\n", var))
cat("-----------------------------------------------------------------\n")
# Get unique values in this variable
groups <- unique(data_clean[[var]])
groups <- groups[!is.na(groups)]
cat(sprintf("Found %d groups: %s\n\n", length(groups), paste(groups, collapse = ", ")))
var_results <- list()
# For each group in the variable
for (group in groups) {
# Subset data for this group only
data_subset <- data_clean[data_clean[[var]] == group, ]
cat(sprintf("  %s (n=%d)...", group, nrow(data_subset)))
# Create formula: year only, controlled for other variables
other_vars <- setdiff(candidate_vars, var)
# Wrap variable names with spaces in backticks
other_vars_formatted <- paste0("`", other_vars, "`")
formula_string <- paste("antibiotic_binary ~ source_year +",
paste(other_vars_formatted, collapse = " + "))
# Fit model for this group
tryCatch({
group_model <- glm(
as.formula(formula_string),
data = data_subset,
family = binomial(link = "logit"),
control = list(maxit = 100)
)
# Extract year terms only
year_terms <- names(coef(group_model))[grepl("source_year", names(coef(group_model)))]
if (length(year_terms) > 0) {
# Calculate CIs manually
coefs <- coef(group_model)[year_terms]
ses <- sqrt(diag(vcov(group_model)))[year_terms]
pvals <- 2 * (1 - pnorm(abs(coefs / ses)))
# Create results data frame
group_results <- data.frame(
Variable = var,
Group = group,
Year_Term = year_terms,
OR = exp(coefs),
Lower_CI = exp(coefs - 1.96 * ses),
Upper_CI = exp(coefs + 1.96 * ses),
P_Value = pvals,
row.names = NULL
) %>%
mutate(
year = case_when(
grepl("2020", Year_Term) ~ "2020",
grepl("2021", Year_Term) ~ "2021",
grepl("2022", Year_Term) ~ "2022",
grepl("2023", Year_Term) ~ "2023",
TRUE ~ NA_character_
),
significance = case_when(
P_Value < 0.001 ~ "***",
P_Value < 0.01 ~ "**",
P_Value < 0.05 ~ "*",
TRUE ~ ""
)
)
var_results[[group]] <- group_results
cat(" âœ“\n")
} else {
cat(" (no year terms)\n")
}
}, error = function(e) {
cat(sprintf(" ERROR: %s\n", as.character(e)))
})
}
# Combine results for this variable
if (length(var_results) > 0) {
stratified_results_list[[var]] <- bind_rows(var_results)
cat(sprintf("âœ“ Stored results for %s\n", var))
} else {
cat(sprintf("âœ— NO RESULTS for %s\n", var))
}
}
# Check what we got
cat("\n")
cat(sprintf("Total variables with results: %d\n", length(stratified_results_list)))
cat(sprintf("Variables processed: %d\n", length(candidate_vars)))
if (length(stratified_results_list) == 0) {
cat("\nWARNING: stratified_results_list is empty!\n")
cat("This means no models produced results.\n")
cat("Check the error messages above.\n")
}
###############################################################
#  COMBINE ALL RESULTS
###############################################################
# Convert Group column to character in all results to avoid type mismatch
stratified_results_list <- lapply(stratified_results_list, function(df) {
df %>% mutate(Group = as.character(Group))
})
all_stratified_results <- bind_rows(stratified_results_list)
cat("\n")
cat("=================================================================\n")
cat("                    RESULTS SUMMARY\n")
cat("=================================================================\n\n")
# Save complete results
write.csv(
all_stratified_results,
paste0(tables_dir, "all_stratified_results.csv"),
row.names = FALSE
)
cat("âœ“ Saved: all_stratified_results.csv\n\n")
# First, check what columns are in all_stratified_results
cat("Columns in all_stratified_results:\n")
print(colnames(all_stratified_results))
# View the first few rows to see the structure
cat("\nFirst few rows:\n")
print(head(all_stratified_results))
###############################################################
#  CREATE SUMMARY TABLE BY VARIABLE AND GROUP
###############################################################
summary_by_group <- all_stratified_results %>%
group_by(`Variable`, `Group`) %>%
summarise(
n_years = n(),
n_significant = sum(`P_Value` < 0.05),
mean_OR = round(mean(`OR`), 3),
min_OR = round(min(`OR`), 3),
max_OR = round(max(`OR`), 3),
.groups = 'drop'
) %>%
arrange(`Variable`, `Group`)
write.csv(
summary_by_group,
paste0(tables_dir, "stratified_summary_by_group.csv"),
row.names = FALSE
)
cat("âœ“ Saved: stratified_summary_by_group.csv\n")
###############################################################
#  DIAGNOSTIC: CHECK all_stratified_results
###############################################################
cat("\nDiagnostic check of all_stratified_results:\n")
cat("-----------------------------------------------------------------\n")
cat("Dimensions:", nrow(all_stratified_results), "rows Ã—",
ncol(all_stratified_results), "columns\n")
cat("Column names:\n")
print(colnames(all_stratified_results))
cat("\nFirst few rows:\n")
print(head(all_stratified_results, 10))
cat("\nUnique values in Variable column:\n")
print(unique(all_stratified_results$Variable))
cat("\nSample of candidate_vars:\n")
print(head(candidate_vars, 5))
###############################################################
#  CREATE FOREST PLOTS BY VARIABLE (with significance colour)
###############################################################
cat("\nCreating forest plots with significance highlighting...\n")
cat("-----------------------------------------------------------------\n")
for (var in candidate_vars) {
# Filter by variable using backticks for column name
var_data <- all_stratified_results %>%
filter(`Variable` == var)
if (nrow(var_data) > 0) {
cat(sprintf("%s...", var))
# Build plot data, flag significance, create ordered yâ€‘label
plot_data <- var_data %>%
mutate(
sig_flag = ifelse(P_Value < 0.05, "Significant", "Not Significant"),
y_label = paste(year, "-", Group)               # e.g., "2020 - Female"
) %>%
# Order groups first (alphabetical), then years ascending
mutate(
y_label = factor(y_label,
levels = unique(
paste(rep(sort(unique(Group)), each = 4),
"-",
rep(c("2020","2021","2022","2023"),
times = length(unique(Group))))
)
)
) %>%
filter(!is.na(y_label))
# Colour palette for significance
my_palette <- c("Significant"   = "indianred",
"Not Significant" = "#708090")
# Forest plot
forest_plot <- ggplot(plot_data,
aes(x = OR, y = y_label, colour = sig_flag)) +
geom_point(size = 3.5, alpha = 0.9) +
geom_errorbarh(aes(xmin = Lower_CI, xmax = Upper_CI),
height = 0.2, size = 1, alpha = 0.8) +
scale_colour_manual(name = "Statistical\nSignificance",
values = my_palette) +
geom_vline(xintercept = 1, linetype = "dashed",
colour = "#000080", size = 1.2) +
labs(
title = paste("Year Trends by", var),
subtitle = "Odds of Antibiotic Within 1 Hour vs. 2019 (Within Each Group)",
x = "Odds Ratio (95% CI)",
y = "Year - Group",
caption = "Red line = OR of 1.0 (reference). Colours indicate statistical significance (p < 0.05)."
) +
theme_minimal() +
theme(
plot.title    = element_text(face = "bold", size = 13, hjust = 0.5),
plot.subtitle = element_text(size = 11, hjust = 0.5),
axis.text.y   = element_text(size = 8),
axis.text.x   = element_text(size = 9, angle = 45, hjust = 1),
legend.title  = element_text(size = 10),
legend.text   = element_text(size = 9),
panel.grid.major.y = element_blank()
)
# Save
ggsave(filename = paste0(figures_dir, "stratified_", var, ".png"),
plot = forest_plot,
width = 12, height = 10, dpi = 300)
cat(" âœ“\n")
} else {
cat(sprintf("\nâš ï¸ No data for %s â€“ skipping.\n", var))
}
}
###############################################################
#              FINAL SUMMARY
###############################################################
cat("\n")
cat("=================================================================\n")
cat("           STRATIFIED ANALYSIS COMPLETE\n")
cat("=================================================================\n")
cat("\nðŸ“Š FILES CREATED:\n")
cat("   Tables:\n")
cat("   âœ“ all_stratified_results.csv\n")
cat("   âœ“ stratified_summary_by_group.csv\n\n")
cat("   Figures:\n")
cat(sprintf("   âœ“ stratified_[VARIABLE].png (%d forest plots)\n",
length(stratified_results_list)))
cat("\nðŸ“ˆ KEY FEATURES:\n")
cat("   âœ“ Reference: 2019 within EACH demographic group\n")
cat("   âœ“ Controls for other variables\n")
cat("   âœ“ Shows if improvements are uniform or disparate\n")
cat("\n")
cat("=================================================================\n")
cat("Results saved to:\n")
cat(tables_dir, "\n")
cat(figures_dir, "\n")
cat("=================================================================\n")
###############################################################
#  CREATE FOREST PLOTS BY VARIABLE (with significance colour)
###############################################################
cat("\n")
cat("Creating forest plots...\n")
cat("-----------------------------------------------------------------\n")
for (var in candidate_vars) {
var_data <- all_stratified_results %>%
filter(Variable == var) %>%
mutate(
sig_flag = ifelse(P_Value < 0.05, "Significant", "Not Significant")
)
if (nrow(var_data) > 0) {
cat(sprintf("%s...", var))
# Colour palette for significance
my_palette <- c("Significant"   = "indianred",
"Not Significant" = "#708090")
# Create forest plot
forest_plot <- ggplot(var_data, aes(x = OR, y = reorder(paste(year, "-", Group), OR),
colour = sig_flag)) +
geom_point(size = 3.5, alpha = 0.8) +
geom_errorbarh(aes(xmin = Lower_CI, xmax = Upper_CI),
height = 0.2, size = 1, alpha = 0.7) +
scale_colour_manual(name = "Statistical\nSignificance",
values = my_palette) +
geom_vline(xintercept = 1, linetype = "dashed", color = "#000080", size = 1.2) +
labs(
title = paste("Year Trends by", var),
subtitle = "Odds of Antibiotic Within 1 Hour vs. 2019 (Within Each Group)",
x = "Odds Ratio (95% CI)",
y = "Year - Group",
caption = "Reference: 2019 within each group. Adjusted for other variables."
) +
theme_minimal() +
theme(
plot.title = element_text(face = "bold", size = 13, hjust = 0.5),
plot.subtitle = element_text(size = 11, hjust = 0.5),
axis.text.y = element_text(size = 8),
axis.text.x = element_text(size = 9, angle = 45, hjust = 1),
legend.title = element_text(size = 10),
legend.text = element_text(size = 9),
panel.grid.major.y = element_blank()
)
# Save plot
ggsave(
paste0(figures_dir, "stratified_", var, ".png"),
forest_plot,
width = 12,
height = 10,
dpi = 300
)
cat(" âœ“\n")
}
}
###############################################################
#  CREATE FOREST PLOTS BY VARIABLE (with significance colour)
###############################################################
cat("\n")
cat("Creating forest plots...\n")
cat("-----------------------------------------------------------------\n")
for (var in candidate_vars) {
var_data <- all_stratified_results %>%
filter(Variable == var) %>%
mutate(
sig_flag = ifelse(P_Value < 0.05, "Significant", "Not Significant"),
y_label = paste(Group, "-", year)
)
if (nrow(var_data) > 0) {
cat(sprintf("%s...", var))
# Create ordered factor: groups alphabetically, then years ascending
var_data <- var_data %>%
mutate(
y_label = factor(y_label,
levels = unique(paste(rep(sort(unique(Group)), each = 4),
"-",
rep(c("2020", "2021", "2022", "2023"),
times = length(unique(Group))))))
)
# Colour palette for significance
my_palette <- c("Significant"   = "darkred",
"Not Significant" = "darkgray")
# Create forest plot
forest_plot <- ggplot(var_data, aes(x = OR, y = y_label,
colour = sig_flag)) +
geom_point(size = 3.5) +
geom_errorbarh(aes(xmin = Lower_CI, xmax = Upper_CI),
height = 0.2, size = 1) +
scale_colour_manual(name = "Statistical\nSignificance",
values = my_palette) +
geom_vline(xintercept = 1, linetype = "dashed", color = "darkblue", size = 1.2) +
labs(
title = paste("Year Trends by", var),
subtitle = "Odds of Antibiotic Within 1 Hour vs. 2019 (Within Each Group)",
x = "Odds Ratio (95% CI)",
y = "Year - Group",
caption = "Reference: 2019 within each group. Adjusted for other variables."
) +
theme_minimal() +
theme(
plot.title = element_text(face = "bold", size = 16, hjust = 0.5),
plot.subtitle = element_text(size = 11, hjust = 0.5),
axis.text.y = element_text(size = 16),
axis.text.x = element_text(size = 16, angle = 45, hjust = 1),
legend.title = element_text(size = 16),
legend.text = element_text(size = 16),
panel.grid.major.y = element_blank()
)
# Save plot
ggsave(
paste0(figures_dir, "stratified_", var, ".png"),
forest_plot,
width = 12,
height = 10,
dpi = 300
)
cat(" âœ“\n")
}
}
###############################################################
#  CREATE FOREST PLOTS BY VARIABLE (with significance colour)
###############################################################
cat("\n")
cat("Creating forest plots...\n")
cat("-----------------------------------------------------------------\n")
for (var in candidate_vars) {
var_data <- all_stratified_results %>%
filter(Variable == var) %>%
mutate(
sig_flag = ifelse(P_Value < 0.05, "Significant", "Not Significant"),
y_label = paste(Group, "-", year)
)
if (nrow(var_data) > 0) {
cat(sprintf("%s...", var))
# Create ordered factor: groups alphabetically, then years ascending
var_data <- var_data %>%
mutate(
y_label = factor(y_label,
levels = unique(paste(rep(sort(unique(Group)), each = 4),
"-",
rep(c("2020", "2021", "2022", "2023"),
times = length(unique(Group))))))
)
# Colour palette for significance
my_palette <- c("Significant"   = "darkred",
"Not Significant" = "darkgray")
# Create forest plot
forest_plot <- ggplot(var_data, aes(x = OR, y = y_label,
colour = sig_flag)) +
geom_point(size = 3.5) +
geom_errorbarh(aes(xmin = Lower_CI, xmax = Upper_CI),
height = 0.2, size = 1) +
scale_colour_manual(name = "Statistical\nSignificance",
values = my_palette) +
geom_vline(xintercept = 1, linetype = "dashed", color = "darkblue", size = 1.2) +
labs(
title = paste("Year Trends by", var),
subtitle = "Odds of Antibiotic Within 1 Hour vs. 2019 (Within Each Group)",
x = "Odds Ratio (95% CI)",
y = "Year - Group",
caption = "Reference: 2019 within each group."
) +
theme_minimal() +
theme(
plot.title = element_text(face = "bold", size = 16, hjust = 0.5),
plot.subtitle = element_text(size = 11, hjust = 0.5),
axis.title.x = element_text(size = 16),
axis.title.y = element_text(size = 16),
axis.text.y = element_text(size = 16),
axis.text.x = element_text(size = 16, angle = 45, hjust = 1),
legend.title = element_text(size = 16),
legend.text = element_text(size = 16),
plot.caption = element_text(size = 16, hjust = 0.5),
panel.grid.major.y = element_blank()
)
# Save plot
ggsave(
paste0(figures_dir, "stratified_", var, ".png"),
forest_plot,
width = 12,
height = 10,
dpi = 300
)
cat(" âœ“\n")
}
}
###############################################################
# READ IN LIBRARIES
###############################################################
library(nichenetr)
library(Seurat)
library(SeuratObject)
library(tidyverse)
library(circlize)
library(dplyr)
library(RColorBrewer)
library(scales)
###############################################################
# READ IN DATA OBJECT
###############################################################
obj <- readRDS("/Users/f002yt8/Documents/Nintedanib/objects/int_r_clus_named")
levels(factor(obj$RNA_clusters))
